<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Comunidade</title>
    <link rel="stylesheet" href="css/styleGlobal.css">
    <link rel="stylesheet" href="css/styleComponents.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 20px 0;
            gap: 10px;
        }
        
        .pagination a, .pagination span {
            padding: 8px 12px;
            text-decoration: none;
            border: 1px solid #ddd;
            border-radius: 4px;
            color: #333;
        }
        
        .pagination a:hover {
            background-color: #f5f5f5;
        }
        
        .pagination .current {
            background-color: #007bff;
            color: white;
            border-color: #007bff;
        }
        
        .pagination .disabled {
            color: #ccc;
            cursor: not-allowed;
        }
        
        .load-comments-btn {
            background-color: #28a745;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            margin: 10px 0;
            font-size: 12px;
        }
        
        .load-comments-btn:hover {
            background-color: #218838;
        }
        
        .load-comments-btn:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
        
        .comentarios {
            margin-top: 10px;
        }
        
        .comentarios.hidden {
            display: none;
        }
    </style>
</head>
<body>
    <%- include('../partials/header') %>

    <form action="/Postar" method="POST">
        <textarea name="texto" placeholder="Escreva algo..." rows="5" cols="40" required></textarea><br>
        <button type="submit">Publicar</button>
    </form>

    <hr>

    <section>
        <h2>Posts Recentes</h2>
        <ul>
            <% if (post && post.length > 0) { %>
                <% post.forEach(p => { %>
                    <%- include('../partials/post', p) %>
                <% }) %>
            <% } else { %>
                <p>Nenhum post ainda.</p>
            <% } %>
        </ul>

        <!-- Controles de Paginação -->
        <% if (typeof pagination !== 'undefined' && pagination.totalPages > 1) { %>
            <div class="pagination">
                <% if (pagination.hasPrev) { %>
                    <a href="/Comunidade?page=<%= pagination.prevPage %>">&laquo; Anterior</a>
                <% } else { %>
                    <span class="disabled">&laquo; Anterior</span>
                <% } %>

                <% for (let i = 1; i <= pagination.totalPages; i++) { %>
                    <% if (i === pagination.currentPage) { %>
                        <span class="current"><%= i %></span>
                    <% } else { %>
                        <a href="/Comunidade?page=<%= i %>"><%= i %></a>
                    <% } %>
                <% } %>

                <% if (pagination.hasNext) { %>
                    <a href="/Comunidade?page=<%= pagination.nextPage %>">Próximo &raquo;</a>
                <% } else { %>
                    <span class="disabled">Próximo &raquo;</span>
                <% } %>
            </div>
        <% } %>
    </section>

    <%- include('../partials/footer') %>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const buttons = document.querySelectorAll('.like-btn');

        buttons.forEach(btn => {
            btn.addEventListener('click', async () => {
                const postId = btn.dataset.postId;

                try {
                    const res = await fetch('/curtir', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ postId })
                    });

                    if (res.ok) {
                        const data = await res.json();
                        const icon = btn.querySelector('i');
                        const countSpan = btn.querySelector('.like-count');

                        if (data.curtiu) {
                            icon.classList.remove('far');
                            icon.classList.add('fas');
                            icon.style.color = 'red';
                        } else {
                            icon.classList.remove('fas');
                            icon.classList.add('far');
                            icon.style.color = '';
                        }

                        countSpan.textContent = data.totalLikes;
                        btn.dataset.curtiu = data.curtiu;
                    }

                } catch (error) {
                    console.error('Erro ao alternar curtida:', error);
                }
            });
        });
    });

    document.addEventListener('DOMContentLoaded', () => {
        const forms = document.querySelectorAll('.form-comentario');

        forms.forEach(form => {
            form.addEventListener('submit', async (e) => {
                e.preventDefault();

                const postId = form.dataset.postId;
                const input = form.querySelector('input[name="texto"]');
                const texto = input.value.trim();

                if (texto === "") return;

                try {
                    const res = await fetch('/comentar', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ postId, texto })
                    });

                    const data = await res.json();

                    if (data.sucesso) {
                        const lista = document.getElementById(`comentarios-${postId}`);
                        const novo = document.createElement('li');
                        novo.innerHTML = `<strong>${data.comentario.username}:</strong> ${data.comentario.texto} <br><small>${data.comentario.createdAt}</small>`;
                        lista.appendChild(novo);

                        input.value = "";
                    }

                } catch (error) {
                    console.error('Erro ao comentar:', error);
                }
            });
        });
    });

    // Função para carregar comentários sob demanda
    async function loadComments(postId) {
        const btn = document.querySelector(`[data-post-id="${postId}"].load-comments-btn`);
        const comentariosDiv = document.getElementById(`comentarios-${postId}`);
        
        btn.disabled = true;
        btn.textContent = 'Carregando...';

        try {
            const res = await fetch(`/comentarios/${postId}`);
            const data = await res.json();

            if (data.sucesso) {
                comentariosDiv.innerHTML = '';
                
                if (data.comentarios.length > 0) {
                    data.comentarios.forEach(c => {
                        const li = document.createElement('li');
                        li.innerHTML = `<strong>${c.username}:</strong> ${c.texto} <br><small>${new Date(c.createdAt).toLocaleString('pt-BR', { timeZone: "America/Sao_Paulo" })}</small>`;
                        comentariosDiv.appendChild(li);
                    });
                } else {
                    comentariosDiv.innerHTML = '<li>Nenhum comentário ainda.</li>';
                }
                
                comentariosDiv.classList.remove('hidden');
                btn.style.display = 'none';
            }

        } catch (error) {
            console.error('Erro ao carregar comentários:', error);
            btn.textContent = 'Erro ao carregar';
        }
    }

    function toggleComments(value) {
        const fields = document.getElementById('commentFields');
        if (value === "1") {
            fields.style.display = 'block';
        } else {
            fields.style.display = 'none';
            document.getElementById('carSpaces').value = '';
            document.getElementById('numSpaces').value = '';
            document.getElementById('plate').value = '';
            document.getElementById('brand').value = '';
            document.getElementById('model').value = '';
        }
    }
</script>

</body>
</html>

